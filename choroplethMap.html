<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="css/style.css">
  <script src="js/d3.v4.min.js"></script>
</head>

  <div class="center" align="center">
  
    <p>
      Año: <select id="yearList" style="width: 100px;">
        <option value=0>...</option>
        <option value=2011>2011</option>
        <option value=2015>2015</option>
      </select>
      Partido: <select id="partyList" style="width: 400px;">
        <option value=0>...</option>
      </select>  
    </p>
        
  </div>

  <div id="mapDiv" class="center" align="center"></div>

<body>
  <script>

  function fillPartyList(year){
  
    var sel = document.getElementById('partyList');
//    document.getElementById('partyList').options.length = 0;
    sel.options.length = 0;
    
    var opt = document.createElement('option');    
    
    opt.innerHTML = "...";
    opt.value = 0;    
    sel.appendChild(opt);    
    
    if (year > 0) {

      d3.csv("data/csv/Datos_"+year+".csv", function(error, data) {
      
//        var sel = document.getElementById('partyList');
        var parties = d3.map(data, function(d){return d.COD_PARTIDO +"||"+ d.NOM_PARTIDO;}).keys();
//        var opt = document.createElement('option');
        
//        opt.innerHTML = "...";
//        opt.value = 0;
//        sel.appendChild(opt);
        
        for(var i = 0; i < parties.length; i++) {
          //console.log(parties[i]);
          opt = document.createElement('option');
          opt.innerHTML = parties[i].split("||")[1];
          opt.value = parties[i].split("||")[0];
          sel.appendChild(opt);
        } 
       
      });  
    
    }
    
  } 

  function drawMap(){ 
  
    var mapWidth = 800;
    var mapHeight = 500;
    
    d3.select("#mapSVG").remove();
    
    var mapSVG = d3.select("#mapDiv").append("svg")
      .attr("id", "mapSVG")    
      .attr("width", mapWidth)
      .attr("height", mapHeight);    
        
    mapSVG.append("rect")
      .attr("x", 0)
      .attr("y", 0)
      .attr("width", mapWidth)
      .attr("height", mapHeight)
      .style("fill", "white")
      .style("stroke", "black")
      .style("stroke-width", 1);   
        
    var projection = d3.geoMercator()
      .center([-74.0, 4.55])
      .scale(42000);

    var path = d3.geoPath()
      .projection(projection);
      
    var div = d3.select("body").append("div")	
      .attr("class", "tooltip")
      .style("opacity", 0);
      
    d3.json("data/GeoJSON/localidadGeojson.json", function(err, geojson) {
    
      var localidad = mapSVG.append("g");
      localidad.selectAll('path')
        .data(geojson.features)
        .enter()
        .append('path')
        .attr('d', path.projection(projection))
        .attr("id", "localidadMapSVG")
//        .attr("class", function(d) { return "localidad_" + d.properties["LOCCODIGO"]; } )
        .style('fill', 'white')
        
        .on("mouseover", function(d) {	
          div.transition()		
          .duration(500)		
          .style("opacity", .9)
          .style("left", (d3.event.pageX) + "px")		
          .style("top", (d3.event.pageY - 28) + "px");		      
        })
        .on("mouseout", function(d) {	
          div.transition()		
          .duration(500)		
          .style("opacity", 0);		      
        })         
        
        
        .style("stroke", 'white')
          
        
        .transition()
        .duration(500)		
        .style('fill', 'white')          
        
        
        .transition()
        .delay(500)		
        .duration(2000)        
        .style('fill', 'Gainsboro')
        
     
        ;
        
    }); 
  
  }  
  
  d3.select("#yearList").on("change", function () {
    year = d3.select("#yearList").property("value");
    if (year == 0) {
      drawMap();
      //console.log("por acá...");
      document.getElementById('partyList').value = 0;
    } 
    fillPartyList(year);   
  });  
    
  d3.select("#partyList").on("change", function () {
    partyCode = d3.select("#partyList").property("value");
    
    if (partyCode == 0) {
      drawMap();
      //console.log("por allá...");
      //document.getElementById('partyList').value = 0;
    } else {
      choroplethMap(year, partyCode);
    }    
    
  });  

  //var color = d3.scaleOrdinal(d3.schemeCategory20);	
  
  function choroplethMap(year, partyCode){ 
  
    //console.log(year);
    //console.log(partyCode);
      
    if (year == 0) {
      console.log ("jai");
    }
  
    d3.csv("data/csv/Datos_"+year+"_partido.csv", function(error, data) {
    
      data = data.filter(function(row) {
        return row['COD_PARTIDO'] == partyCode;
      });
      
      //console.log(data);
      
      var values = [];
      for (var key in data[0]) {
        if (key != "TOTAL" && key != "COD_PARTIDO" && key != "NOM_PARTIDO") { 
          if (data[0].hasOwnProperty(key)) {
            if ( !isNaN(Number(data[0][key])) ) {
                values.push(Number(data[0][key]));      
            }
          }
        }
      }
      
      var opacityScale = d3.scaleLinear()
        .domain([d3.min(values), d3.max(values)])
        .range([0.04,1]);

        d3.selectAll("#localidadMapSVG")
      
        .transition()
        .duration(500)		
        .style('fill-opacity', function (d, i) { 
          return ( opacityScale( data[0][Number(d.properties["LOCCODIGO"])] ) );
        })
        .style('fill', 'white')  
      
      
        .transition()
        .delay(500)
        .duration(2000)		
        .style('fill', function () { return "blue";
        /*
          if (partyCode == 0) {
            return "Gainsboro";
          } else if (partyCode == 1) {
            return "red";
          } else if (partyCode == 2) {
            return "blue";
          } else if (partyCode == 5) {
            return "green";
          } else {
            return "orange";
          }
          */
        });
     
    });  
  
  }
  
  drawMap();
      
  </script>
</body>
